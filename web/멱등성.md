컴퓨터 과학에서 멱등하다는 것이란 첫 번째 수행 이후에 여러 차례 적용해도 결과를 변경시키지 않는 작업 또는 기능의 속성을 뜻한다. 즉, 멱등한 작업의 결과는 한 번 수행하든 여러 번 수행하든 같다.

## HTTP 메서드의 멱등성

| 메서드 | 멱등성|
| ---- | ---- |
| CONNECT | X |
| DELETE | O |
| GET | O |
| HEAD | O |
| OPTIONS | O |
| POST | X |
| PUT | O |
| PATCH | X |
| TRACE | O |

HTTP 메서드의 안전성와 멱등성은 어떻게 다를까? 안전성이 보장된 메서드는 리소스를 변경하지 않는다. GET, HEAD, OPTIONS는 안전한 메서드이다. 안전성이 보장된 메서드는 무조건 멱등성을 보장하지만, 멱등성이 보장되어 있다고 안전성을 무조건 보장하지 않는다.

## API 관점에서 멱등성

멱등한 API라면 두 번 이상 요청해도 결과는 처음 요청과 똑같이 돌아온다. 단순히 돌아온 값이 같을 뿐 아니라 서버 상태(DB)에도 영향을 미치지 않아야 한다. 시스템에 의도하지 않은 문제를 일으키지 않고 요청을 재시도할 수 있는 안전한 API를 만드는 것은 중요하다.

## 멱등한 요청인지 어떻게 알 수 있는가?

멱등성을 보장하기 위해서는 멱등키를 API 요청에 포함하는 것으로 가능하다. 이전 요청과 동일한 멱등키를 가진 요청을 받으면 서버에서 중복으로 판단하여 실제로 처리하지 않고 첫 요청과 같은 응답을 내보낸다. 요청 본문, URL 쿼리 매개변수, 헤더 중 하나에 멱등키를 보내면 되는데 IETF에서는 요청 헤더에 포함하는 방법을 표준으로 제안한다.

`Idempotency-Key: {IDEMPOTENCY_KEY}`

```bash
curl --request POST \
  --url https://api.tosspayments.com/v1/payments/5zJ4xY7m0kODnyRp/cancel \
  --header 'Authorization: Basic dGVzdF9nc2tfZG9jc19PYVB6OEw1S2RtUVhrelJ6M3k0N0JNdzY6' \
  --header 'Content-Type: application/json' \
  --header 'Idempotency-Key: SAAABPQbcqjEXiDL' \
  --data '{"cancelReason":"구매자 변심"}'
```

## 멱등키 구현시 에러 시나리오

| 에러코드 | 시나리오 |
| ------ | ------ |
| 400 Bad Request | 멱등해야 하는 API 요청에 멱등키가 누락됐거나 형식에 맞지 않는 키값이 들어왔을 때 |
| 409 Conflict | 이전 요청 처리가 아직 진행 중인데 같은 멱등키로 새로운 요청이 올 때 |
| 422 Unprocessable Entity | 재시도 된 요청 본문(payload)이 처음 요청과 다른데 같은 멱등키를 또 사용했을 때 |