## 메모리 높이기

lambda 함수의 성능 개선의 가장 간단하면서 빠른 방법은 메모리를 높이는 것이다. 물론 해당 방식을 사용하면 쉽고 빠르게 성능 개선이 되지만 당연히 요금이 많이 발생하게 된다. lambda의 과금 방식은 "메모리 수준 * 요청 처리 시간 * 요청 수"로 정산되기 때문이다.

lambda의 경우 메모리를 올리면 올라간 메모리에 비례해서 CPU 성능이 함께 올라간다. lambda에서 CPU를 별도로 설정할 수는 없기 때문이다. 그렇기 때문에 메모리를 올리면서 함께 늘어난 CPU 성능이 처리 시간을 개선하게 되고, 이것이 오히려 낮은 메모리에 비해서 비용 효율화로 이어질 수도 있다.


## lambda 함수 컨테이너 재사용(warm start)

일단 lambda 함수의 재사용을 알기 위해서 동작 원리를 확인해보자. lambda의 핸들러는 크게 4단계를 거쳐서 실행된다.

1. 초기화 단계 (Init Phase)
    함수가 처음 호출되거나 규모 확장이 필요할 때 새로운 실행 환경을 준비하는 단계. 흔히 cold start라고 불리는 단계이다.

    1. 환경 설정: Lambda 서비스가 함수 구성에 지정된 메모리 용량 등을 바탕으로 컴퓨팅 리소스를 할당하고 코드를 다운로드
    2. 익스텐션 시작(Extension Init): 등록된 모든 외부 익스텐션 프로세스를 시작
    3. 런타임 부트스트랩(Runtime Init): 선택한 언어(Python, Java 등)의 런타임을 준비
    4. 정적 코드 실행(Function Init): 핸들러 메서드 외부에 작성된 코드를 실행합니다. 이 단계에서 라이브러리를 임포트하거나 데이터베이스 연결 객체 등을 미리 생성하여 다음 호출에서 재사용할 수 있도록 준비
2. 간접 호출 단계 (Invoke Phase)
    실행 환경 준비가 완료되면 실제 비즈니스 로직이 담긴 코드가 실행

    1. 이벤트 전달: 런타임이 호출 이벤트와 컨텍스트 정보(함수 이름, 요청 ID 등)를 JSON 형태로 구성하여 핸들러로 전달합니다.
    2. 핸들러 실행: 정의된 핸들러(진입점)가 실행되어 로직을 처리합니다.
    3. 응답 및 정지: 처리가 끝나면 결과를 반환합니다. 호출이 완료되면 실행 환경은 일시적으로 '동결(Frozen)' 상태가 되어 리소스 사용을 멈춥니다.
3. 실행 환경 재사용 (Warm Start)
    Lambda는 성능 향상을 위해 호출이 끝난 환경을 즉시 삭제하지 않고 일정 기간 유지합니다.

    유지되는 동안 동일한 함수에 요청이 다시 들어오면 초기화 단계를 건너뛰고 즉시 호출 단계로 넘어갑니다. 이를 **'웜 스타트(Warm Start)'**라고 하며, 전역 변수나 미리 연결된 DB 세션 등을 그대로 사용하여 훨씬 빠르게 응답합니다.
4. 종료 단계 (Shutdown Phase)
    더 이상 요청이 없거나 유지 기간이 지나면 환경을 정리합니다.

    1. 종료 알림: Lambda가 익스텐션에 Shutdown 이벤트를 보내 최종 정리 작업을 수행할 기회를 줍니다.
    2. 프로세스 종료: 정해진 시간 내에 응답이 없으면 모든 프로세스를 강제로 종료(SIGKILL)하고 환경을 삭제합니다.

여기서 lambda 핸들러의 내부 함수 코드는 event, context 매개변수의 값을 받는 main 함수의 역할을 하는 함수를 말한다. 같은 모듈에 있어도 해당 함수 외부에서 실행되는 코드는 모두 전역 코드가 된다.

또한 위에서 1 ~ 3번 과정은 모두 cold start에 해당한다. 4번 과정만 warm start에 해당한다. lambda 함수는 5 ~ 15분 이내에 실행되지 않을 경우 일종의 절전 상태로 들어간다. 절전 상태로 들어간 함수는 새로운 실행 트리거가 들어왔을 때, cold start 과정부터 실행하게 된다. 절전 상태로 들어가지 않았을 경우에는 1 ~ 3번 과정의 초기화는 모두 이전의 초기화 및 상태를 유지한다.

절전 상태로 들어가는 정확한 시간은 제공되지 않았다.

위와 같은 작동원리에 근거해서 일반적으로 초기화 시간이 오래 걸리는 작업은 lambda 핸들러 함수 외부의 전역 공간에서 초기화시킨다. 예를 들면 데이터베이스 연결 객체의 경우 전역 공간에 별도로 초기화 시키고 계속해서 사용하는 방식을 선택할 수 있다.


## 프로비저닝된 동시성

warm start의 이점을 누리기 위해서 aws lambda 함수를 5분 이내에 계속해서 호출할 수 있다. 하지만 일부에서는 해당 방식이 완벽히 warm start를 보장하는 것이 아니며, 불필요한 호출로 인해 요금이 상승할 수 있다는 우려가 있다.

aws에서는 이를 위해 프로비저닝된 동시성이라는 기능을 제공한다. 설정한 숫자만큼의 컨테이너 인스턴스를 미리 초기화시켜 놓고 warm start 상태로 유지시키는 것이다. 상태를 유지시키는 동시성 인스턴스의 개수와 각 인스턴스에 할당된 메모리 그리고 유지 시간이 곱 연산되어 요금으로 계산된다.

그래서 생각보다 꽤나 높은 요금이 부과될 수 있어 주의가 요구된다. 해당 방식은 트래픽이 몰릴 가능성이 높은 시간대에 예약하는 방식으로 사용하는 경우가 많다.


## SnapStart

초기화된 상태의 메모리 및 디스크 스냅샷을 저장해 두었다가, 호출 시 처음부터 초기화하는 대신 스냅샷에서 빠르게 복구하여 실행


## lambda 실행 환경 관련 문서

https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/lambda-runtime-environment.html