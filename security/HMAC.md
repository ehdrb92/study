HMAC(Hash-based Message Authentication Code)은 "데이터 단위"의 무결성과 출처를 증명하는 도구이다.

메시지를 전송하고 받는 각 엔드포인트에 위치하는 클라이언트와 서버는 같은 비밀 키를 공유한다. 그리고 메시지를 보내는 쪽에서 비밀 키를 이용해서 데이터를 해시화한 MAC데이터를 만들어서 실제 데이터와 함께 전송한다. 메시지를 받는 쪽은 실제 데이터를 가지고 있던 비밀 키로 해시화하여 MAC를 만들어본다. 그리고 받은 MAC와 비교해서 동일하면, 위변조되지 않은 데이터로 판단한다.

HMAC은 데이터가 네트워크를 통해 전송되는 중간에 위변조가 되지 않았음을 증명하기 위해 사용된다.

## HTTPS와 관계

사실 데이터를 주고받을 때 데이터 도청을 방지하기위한 수단인 HTTPS가 있다. HTTPS가 있다면 굳이 HMAC이 필요한지 의문이 들 수 있다. 보통은 HTTPS로도 충분히 방어가 되지만, HTTPS는 전송 중 보안될 뿐이다.

사실 클라이언트와 서버간에 데이터가 전송될 때는 로드밸런서, 프록시 서버, 메시지 큐와 같은 여러 중간 단계를 거칠 가능성이 높다. 그런데 일반적으로 TLS는 로드밸런서나 프록시 서버 등에서 헤제되게 된다.

왜 최종 엔드포인트 서버까지 TLS를 유지시키지 않는가에 대한 이유는 다음이 존재한다.

1. 요청 데이터 분석
    로드 밸런서 혹은 프록시는 단순히 트래픽을 그대로 업스트림으로 통과시키는 장치가 아니다.
    - 요청 헤더를 읽고 어떤 서버로 보낼지 판단
    - 쿠키나 세션 값, URL 경로 등을 기반으로 라우팅 결정
    - 캐싱, 로깅, 압축, 인증 등 다양한 작업도 수행
    그런데 만약 TLS로 암호화되어 있다면 내용을 읽을 수 없다. 그래서 결국 해당 포인트에서 헤제를 해야만 한다.
2. 인증서 관리
    클라이언트가 접속하는 도메인의 인증서는 일반적으로 로드 밸런서가 관리하게 된다. 이유는 간단하다.
    - 로드 밸런서가 여러 백엔드 서버로 트래픽을 분산시키기 때문에, 클라이언트는 백엔드 서버를 직접 마주하지 않는다.
    - 모든 종단 서버가 각각의 TLS 인증서를 가지면, 관리가 매우 번거로우며 비용도 크다.
    위 이유로 TLS는 로드 밸런서가 관리하고, 그 뒤에 위치한 내부망은 평문의 HTTP로 돌리는게 일반적이다. 또한 이러한 것은 내부망이 완전히 외부와 고립된 공간이라는 가정하에서 가능하다. 보안 수준이 높은 기관(금융, 클라우드 서비스 등)은 내부 공간에서도 TLS를 유지하거나 HMAC을 추가로 사용한다.