JWT 기반의 인증 방식을 채용할 때, 보안을 위해 채용되는 방법 중 엑세스 토큰과 리프레시 토큰을 활용한 방식이 많이 채택된다. 이 방식은 어떤 특징으로 보안을 강화하는걸까?

해당 방식에서 엑세스 토큰은 인증된 사용만 접근할 수 있는 모든 API 요청에 사용된다. 그렇기에 클라이언트와 서버 사이에서 굉장히 빈도 높게 사용된다. 이에 반해 리프레시 토큰의 경우 일반적으로 엑세스 토큰의 갱신 시에만 통신 경로를 통해 이동하게 된다.

이러한 역할 때문에 아무래도 외부 경로에 노출될 상황 자체가 가끔씩이기에 해커에게 노출될 확률도 적다.

또한 엑세스 토큰의 만료기한은 리프레시 토큰에 비해 굉장히 짧게 설정한다. 그렇기에 만약 노출된 상황이라고 할지라도 탈취자가 많은 문제를 일으키기 전에 자동으로 만료되어 문제의 크기를 줄일 수 있다.


## 토큰 보안 강화 방법

위에서 별도로 설명하지 않았지만 기본적으로 엑세스 토큰은 별도의 데이터베이스에 저장하지 않고 그 자체만으로 최소한의 데이터를 가져 인증이 된다. 오직 리프레시 토큰만 서버의 데이터베이스에 저장한다. 이렇게 하면 무상태성을 유지하면서 매 요청에서 데이터베이스를 거치는 오버헤드를 줄일 수 있다.

하지만 경우에 따라 짧은 유효기간의 엑세스 토큰도 문제를 일으킬 가능성이 존재한다. 그래서 보안 강화의 목적으로 엑세스 토큰도 데이터베이스에 저장하는 경우가 많다. 사용자가 로그아웃을 하거나 위험한 접근이 인지된 즉시 해당 토큰을 블랙리스트에 포함시켜 접근을 막는 것이다. 이렇게 하면 비록 매 요청 데이터베이스를 확인해야하고, 정보를 저장할 공간이 필요하며 무상태성이 깨지게 된다.

대신에 관계형 데이터베이스 대신 인메모리 데이터베이스인 Redis를 사용하고, Redis에는 토큰에 대한 최소한의 정보만 저장한다. 이렇게 하면 보안적인 이점을 얻으면서 손실을 최소화할 수 있다.

만약 무상태성을 포기할 수 없는 상황이라면, 엑세스 토큰의 유효기간을 굉장히 짧게할 수는 있다. 하지만 그 만큼 리프레시 토큰의 외부 노출이 잦아지고, 토큰 갱신도 자주 해야한다.

세상 모든 일은 트레이드 오프이다.


## 토큰의 탈취

위 사항은 모두 토큰이 탈취된다는 가정하에 보안 강화 방법이다. 그렇다면 토큰 탈취는 보통 어떤 상황에서 발생할까? 왠만한 상황에서는 프로덕션 수준의 애플리케이션이 HTTPS가 아닌 HTTP로 외부에 배포될 일은 없다. 그리고 토큰은 요청과 응답의 헤더 혹은 본문을 통해 전달된다. HTTPS를 사용한다면 헤더와 본문은 암호화되며 TLS가 종료되기 전의 암호화된 값을 복호화하는 것은 확률상 불가능에 가깝다. 그리고 왠만하면 TLS 종료는 특정 내부 네트워크로 입장하는 게이트웨이에서 종료하게된다.

그렇다면 도대체 언제 탈취된다는 말인가?

첫 번째, 클라이언트 취약 점이다. 사용자의 브라우저에서는 이미 값이 복호화된 이후이다. 또한 개발 전문가가 아닌 사용자는 외부 보안 위협에 아주 취약하다. 위험성을 모르고 이러저러한 컨텐츠를 소비할 가능성이 높다. 그렇기에 악성 사이트 접속 혹은 이메일 링크 접속 등으로 굉장히 쉽게 토큰이 탈취된다. 또한 공용 네트워크에서 접속하거나 누군가가 사용자 컴퓨터를 몰래 사용하는 물리적인 방법으로 탈취가 될 수 있다.

두 번째, 개발자 과실이다. 토큰은 HTTP 헤더 혹은 본문에 저장하는게 원칙이다. 하지만 개발자가 멍청하게 쿼리 매개변수와 같은 방법으로 노출된 URL에 토큰을 넣을 수 있다. 또한 토큰 값을 로그로 기록했다가 로그 파일이 저장된 파일 혹은 ELK와 같은 데이터베이스가 털려서 탈취당할 수 있다.

세 번째, 중간자 공격의 변형이다. 공격자는 사용자에게 보안 업데이트라는 명목으로 속여서 공격자의 루트 인증서를 사용자 PC에 설치하도록 할 수 있다. 이렇게 되면 사용자가 잘못된 인증서로 요청을 보내고, 이를 공격자가 복호화하여 토큰 탈취가 된다. 또한 SSL Stripping와 같은 방식이 있다.

네 번째, 내부 네트워크에서의 문제이다. 내부 네트워크로 들어올 때 대부분 TLS가 이미 종료된 이후이다. 내부 네트워크를 외부와 완전히 분리한다고 해도, 예상치 못한 방식으로 내부 네트워크에 공격자가 침투해버리면 그때부터는 완전히 무력해진다. 또한 쿠버네티스 환경 등에서 컨테이너 옆에 붙어있는 사이드카(Sidecar)나 프록시 설정이 잘못되어 토큰이 노출되는 경우도 있다고 한다.